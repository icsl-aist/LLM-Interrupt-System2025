# LLM-Interrupt-System2026
## プロジェクト名

山本研究室（知的制御研究室）LLMチーム2026卒業研究制作物

## ディレクトリ構成

### 📂 ルートディレクトリ
システムを実行するためのメインスクリプトと設定ファイル群です。

| ファイル名 | 説明 |
|------------|------|
| `manager.py` | **【操作用】** ユーザーがコマンドを入力し、ロボットへ指令を送る送信機プログラム |
| `robots_client.py` | **【ロボット用】** ロボット側で動作し、指令を受け取ってタスクを実行する受信機プログラム |
| `config.py` | IPアドレス、APIキー、ファイルパスなどのシステム全体設定 |
| `robot_api_manager.py` | KachakaとAkariの接続・初期化を管理するシングルトンクラス |
| `requirements.txt` | 必要なPythonライブラリの一覧 |

---

### 📂 `_LLM/` (LLM制御・生成ロジック)
LLM（ChatGPT）との通信、プロンプト管理、ログ保存を行うモジュール群です。

| ファイル名 | 説明 |
|------------|------|
| `LLM_manager.py` | OpenAI API通信、ログ保存、トークン計算を行う共通機能 |
| `task_generate.py` | ユーザー指示から「行動計画（Pythonコード）」を生成するスクリプト |
| `talk_generate.py` | 行動計画に基づき「ロボットの発話内容」を生成するスクリプト |

#### 📂 `_LLM/prompt/` (プロンプト定義)
LLMへの指示書（システムプロンプト）が格納されています。
本システムでは主に以下の **_en.json** ファイルを使用します。

| ファイル名 | 説明 |
|------------|------|
| `re_create_task_en.json` | **【行動生成用】** ユーザーの指示をPythonコード（移動・運搬）に変換するためのプロンプト |
| `re_create_talk_en.json` | **【会話生成用】** 生成された行動に合わせて、ロボットが話す内容を生成するためのプロンプト |

#### 📂 `_LLM/log/` (実行ログ)
システムの実行履歴やコスト管理用のログファイルです。

| ファイル名 | 説明 |
|------------|------|
| `task_log.txt` | LLMが生成した「行動計画スクリプト」の履歴 |
| `talk_log.txt` | LLMが生成した「会話スクリプト」の履歴 |
| `token_log.txt` | OpenAI APIのトークン使用量と概算コストの記録 |

---

### 📂 `_robot_function/` (ロボット制御定義)
各ロボットの具体的な動作メソッドを定義したライブラリです。

| ファイル名 | 説明 |
|------------|------|
| `function_list_kachaka.py` | Kachaka用機能（移動、棚運び、発話、ガード処理） |
| `function_list_akari.py` | Akari用機能（M5Stack表情、首振り、発話） |

### 📂 `_robot_programs/` (生成コード保存先)
LLMによって自動生成されたスクリプトが保存されます。

| ファイル名 | 説明 |
|------------|------|
| `llm_task.txt` | 一時的に生成された行動計画スクリプト（会話生成の入力として使用） |
| `llm_final.txt` | 会話文が付与された、最終的に実行されるスクリプト |

---

## 主要スクリプトの詳細

### 1. `manager.py` (指令用)
ユーザーがPCのターミナルからロボットに命令を送るためのインターフェースです。
MQTTブローカーを介して `robots_client.py` と通信します。

**主なコマンド:**
- **基本操作**
    - `order <指示内容>` : LLMに行動生成を依頼します
    - `start <ファイル名>` : 指定したタスクファイルを実行します
- **実行制御・割り込み**
    - `stop` : 全ロボットを緊急停止します
    - `pause` : 実行中のタスクを一時停止します
    - `resume` : 一時停止したタスクを再開します
    - `skip` : 現在実行中のアクションをスキップします
    - `reset` : ロボットの状態やフラグをリセットします
- **直接操作**
    - `kachaka <コマンド>` / `akari <コマンド>` : 各ロボットの機能を直接実行します

### 2. `robots_client.py` (実行用)
ロボットを制御するPC上で常駐させるメインプログラムです。
`manager.py` からの指令を待ち受け、以下の処理を行います。
1. **LLM生成**: `_LLM/prompt/re_create_task_en.json` 等を使用してコードを生成
2. **動的実行**: `_robot_programs/llm_final.txt` を読み込み、ロボット実機を制御
3. **割り込み制御**: 実行中のタスクに対して、STOP, PAUSE等の割り込み処理を優先的に実行

---

## 使用方法

### 必要な環境
- Python 3.10 以上推奨
- OpenAI API Key (GPT-4o利用のため)
- MQTTブローカー (Mosquitto等が稼働していること)
- `requirements.txt` に記載されたライブラリ

### セットアップ手順

1. **ライブラリのインストール**
   ```bash
   pip install -r requirements.txt

2. **OpenAI APIキーの設定**
システムはGPT-4oを使用するため、APIキーが必要です。環境変数として設定してください。（APIキーは研究室のデスクトップPC内に保存）

Mac/Linux:

export OPENAI_API_KEY="sk-xxxxxxxxxxxxxxxxxxxxxxxx"

### 実行手順

**1. ロボットクライアントの起動 (受信側)**
ロボットを制御するPCで実行します。

```bash
python robots_client.py

